<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WhatsApp Automation Dashboard</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
    }
    h1, h2, h3 {
      color: #075e54;
    }
    button {
      background: #25D366;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      margin: 8px 0;
      transition: background 0.2s;
      font-weight: 600;
    }
    button:hover {
      background: #128C7E;
    }
    button:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }
    textarea, input, #qr-container {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-size: 16px;
    }
    .status {
      padding: 12px;
      margin: 12px 0;
      border-radius: 8px;
      background: #ffe6e6;
      border-left: 4px solid #ff3333;
      display: none;
    }
    .status.ready {
      background: #e6ffe6;
      border-left: 4px solid #4CAF50;
      display: block;
    }
    .status.qr {
      background: #fffae6;
      border-left: 4px solid #FFD700;
      display: block;
    }
    .status.auth_failure {
      background: #ffe6e6;
      border-left: 4px solid #ff3333;
      display: block;
    }
    #qr-container {
      display: flex;
      justify-content: center;
      margin: 12px 0;
    }
    #report {
      margin-top: 20px;
      border-top: 1px solid #eee;
      padding-top: 16px;
    }
    #report div {
      padding: 8px;
      margin: 4px 0;
      border-radius: 6px;
      background: #f9f9f9;
    }
    #report div.success {
      background: #e6ffe6;
      border-left: 3px solid #4CAF50;
    }
    #report div.failed {
      background: #ffe6e6;
      border-left: 3px solid #f44336;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>WhatsApp Automation Dashboard</h1>
    <p>Connect to your WhatsApp account via QR code, check status, and send automated messages.</p>
    
    <h2>WhatsApp Login</h2>
    <button id="show-qr">Get QR Code</button>
    <div id="qr-container"></div>
    
    <h2>Status</h2>
    <div id="status" class="status"></div>
    
    <h2>Send Message</h2>
    <div>
      <label for="numbers">Recipient Numbers (one per line, e.g., 919876543210):</label>
      <textarea id="numbers" rows="5" placeholder="919876543210
+919876543211"></textarea>
      <label for="message">Message Text (optional):</label>
      <input type="text" id="message" placeholder="Hello from the API!">
      <label for="media">Media File Path (optional, e.g., ./poster.png):</label>
      <input type="text" id="media" placeholder="./poster.png">
      <button id="send">Send Message</button>
    </div>
    
    <div id="report"></div>
  </div>

  <script>
    const apiBase = 'http://localhost:3000';

    // DOM elements
    const qrBtn = document.getElementById('show-qr');
    const qrContainer = document.getElementById('qr-container');
    const statusEl = document.getElementById('status');
    const numbersEl = document.getElementById('numbers');
    const messageEl = document.getElementById('message');
    const mediaEl = document.getElementById('media');
    const sendBtn = document.getElementById('send');
    const reportEl = document.getElementById('report');

    // Update status display
    function updateStatus(status) {
      statusEl.textContent = status.status;
      statusEl.className = 'status';
      statusEl.classList.add(status.status === 'ready' ? 'ready' : 
                            status.status === 'qr' ? 'qr' : 
                            status.status === 'auth_failure' ? 'auth_failure' : '');
    }

    // Check and update WhatsApp status
    async function checkStatus() {
      try {
        const res = await fetch(`${apiBase}/api/status`);
        const data = await res.json();
        updateStatus(data);
        return data.status === 'ready';
      } catch (err) {
        statusEl.textContent = 'Cannot connect to API server. Is it running?';
        statusEl.className = 'status auth_failure';
        return false;
      }
    }

    // Automatically refresh status every 2 seconds
    setInterval(checkStatus, 2000);
    checkStatus();

    // Show QR code for login
    qrBtn.addEventListener('click', async () => {
      try {
        const res = await fetch(`${apiBase}/api/qr`);
        const data = await res.json();
        if (data.qr) {
          qrContainer.innerHTML = `<img src="${data.qr}" alt="WhatsApp QR Code" style="max-width:300px;height:auto;">`;
        } else {
          qrContainer.innerHTML = `<p>${data.error || 'QR code not available yet. Wait and try again.'}</p>`;
        }
      } catch (err) {
        qrContainer.innerHTML = '<p>Error fetching QR code. Is the API running?</p>';
      }
    });

    // Send messages (text + media) to numbers
    sendBtn.addEventListener('click', async () => {
      if (!(await checkStatus())) {
        alert('WhatsApp is not ready. Please authenticate first.');
        return;
      }

      const numbers = numbersEl.value
        .split('\n')
        .map(n => n.trim())
        .filter(n => n.length > 0);

      if (numbers.length === 0) {
        alert('Please enter at least one recipient number.');
        return;
      }

      const message = messageEl.value.trim();
      const mediaPath = mediaEl.value.trim();

      if (!message && !mediaPath) {
        alert('Please provide a message or media path.');
        return;
      }

      sendBtn.disabled = true;
      reportEl.innerHTML = '<p>Sending messages...</p>';

      try {
        const res = await fetch(`${apiBase}/api/send-message`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ numbers, message, mediaPath })
        });
        const data = await res.json();
        reportEl.innerHTML = '';
        data.report.forEach(item => {
          const div = document.createElement('div');
          div.textContent = `${item.number} â€” ${item.message}`;
          div.classList.add(item.status);
          reportEl.appendChild(div);
        });
      } catch (err) {
        reportEl.innerHTML = `<div class="failed">Failed to send messages: ${err.message}</div>`;
      } finally {
        sendBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
